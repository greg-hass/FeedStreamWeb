(()=>{"use strict";var e={};e.d=(t,o)=>{for(var a in o)e.o(o,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:o[a]})},e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);let t="syncQueue";self.addEventListener("push",e=>{if(e.data)try{let t=e.data.json(),o=t.title||"New Article",a={body:t.body||"You have a new article to read",icon:"/icon-192.png",badge:"/icon-192.png",tag:t.tag||"article-notification",data:{url:t.url||"/",articleId:t.articleId}};e.waitUntil(self.registration.showNotification(o,a))}catch(e){console.error("Push notification error:",e)}}),self.addEventListener("notificationclick",e=>{e.notification.close();let t=e.notification.data?.url||"/";e.waitUntil(self.clients.matchAll({type:"window",includeUncontrolled:!0}).then(e=>{for(let o of e)if(o.url.includes(self.location.origin)&&"focus"in o)return o.navigate(t),o.focus();if(self.clients.openWindow)return self.clients.openWindow(t)}))}),self.addEventListener("pushsubscriptionchange",()=>{console.log("Push subscription changed - may need to re-subscribe")});let o=[".jpg",".jpeg",".png",".gif",".webp",".svg",".ico"];async function a(){try{let e=await new Promise(e=>{let t=indexedDB.open("FeedStreamDB");t.onerror=()=>{console.error("[SW] IndexedDB error:",t.error),e(null)},t.onsuccess=()=>{e(t.result)}});if(!e)return void console.log("[SW] Could not open IndexedDB");let o=e.transaction(t,"readonly").objectStore(t),a=await r(o.getAll());if(0===a.length){console.log("[SW] No pending sync items"),e.close();return}console.log(`[SW] Processing ${a.length} sync items`);let s=await i("NEXT_PUBLIC_SUPABASE_URL"),d=await i("NEXT_PUBLIC_SUPABASE_ANON_KEY");if(!s||!d){console.log("[SW] Supabase not configured, skipping cloud sync"),e.close();return}for(let o of a)try{await n(o,s,d);let a=e.transaction(t,"readwrite");a.objectStore(t).delete(o.id),await r(a)}catch(e){console.error(`[SW] Failed to sync item ${o.id}:`,e)}e.close(),console.log("[SW] Background sync completed")}catch(e){console.error("[SW] Background sync error:",e)}}async function n(e,t,o){let a=`${t}/rest/v1`,n={apikey:o,Authorization:`Bearer ${o}`,"Content-Type":"application/json",Prefer:"return=minimal"};switch(e.table){case"articles":{let t={id:e.recordId,article_url:e.data.url||e.recordId,feed_id:e.data.feedID,is_read:1===e.data.isRead,is_bookmarked:1===e.data.isBookmarked,playback_position:e.data.playbackPosition||0,updated_at:new Date().toISOString()};await fetch(`${a}/sync_article_states`,{method:"POST",headers:{...n,Prefer:"resolution=merge-duplicates"},body:JSON.stringify(t)});break}case"folders":"delete"===e.operation?await fetch(`${a}/sync_folders?id=eq.${e.recordId}`,{method:"PATCH",headers:n,body:JSON.stringify({deleted_at:new Date().toISOString()})}):await fetch(`${a}/sync_folders`,{method:"POST",headers:{...n,Prefer:"resolution=merge-duplicates"},body:JSON.stringify({id:e.recordId,name:e.data.name,position:e.data.position,updated_at:new Date().toISOString()})});break;case"feeds":"delete"===e.operation?await fetch(`${a}/sync_feeds?id=eq.${e.recordId}`,{method:"PATCH",headers:n,body:JSON.stringify({deleted_at:new Date().toISOString()})}):await fetch(`${a}/sync_feeds`,{method:"POST",headers:{...n,Prefer:"resolution=merge-duplicates"},body:JSON.stringify({id:e.recordId,title:e.data.title,feed_url:e.data.feedURL,site_url:e.data.siteURL,folder_id:e.data.folderID,icon_url:e.data.iconURL,type:e.data.type,is_paused:e.data.isPaused,sort_order:e.data.sortOrder,is_favorite:e.data.isFavorite,updated_at:new Date().toISOString()})})}}function r(e){return new Promise((t,o)=>{e instanceof IDBTransaction?e.oncomplete=()=>t(void 0):e.onsuccess=()=>t(e.result),e.onerror=()=>o(e.error)})}async function i(e){return null}self.addEventListener("fetch",e=>{let t=new URL(e.request.url),a=o.some(e=>t.pathname.toLowerCase().endsWith(e)),n=t.pathname.startsWith("/api/proxy"),r=t.hostname.includes("google.com")&&t.pathname.includes("favicons"),i=t.hostname.includes("ytimg.com")||t.hostname.includes("ggpht.com");"GET"===e.request.method&&(a||n||r||i)&&e.respondWith(caches.open("article-thumbnails-v1").then(async t=>{let o=await t.match(e.request),a=fetch(e.request).then(o=>(o.ok&&t.put(e.request,o.clone()),o)).catch(()=>null);return o||a}))}),self.addEventListener("sync",e=>{console.log("[SW] Background sync triggered:",e.tag),"sync-cloud"===e.tag?e.waitUntil(a()):("sync-read-state"===e.tag||"sync-bookmarks"===e.tag)&&e.waitUntil(a())}),self.addEventListener("periodicsync",e=>{"sync-feeds"===e.tag&&e.waitUntil(a())})})();